pipeline {
  agent any

  parameters {
    string(name: 'vpc_name', description: 'VPC Name')
    string(name: 'env', description: 'Environment Name')
  }

  environment {
    TF_DIR = 'environments/dev'
  }

  stages {
    stage('Terraform Init & Apply') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-credentials', // ğŸ” Update with your actual AWS credentials ID
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          dir("${env.TF_DIR}") {
            sh '''
              set -e  # â›” Exit immediately if any command fails

              echo "ğŸ“„ Preparing terraform.tfvars from template..."

              # âœ… Replace template variables with parameter values
              sed -e "s|\\\${vpc_name}|${vpc_name}|g" \
                  -e "s|\\\${env}|${env}|g" terraform.tfvars.template > terraform.tfvars

              echo "ğŸ§ª Checking Terraform version..."
              terraform -version

              echo "ğŸ“¦ Running terraform init..."
              terraform init -input=false

              echo "ğŸ§  Generating terraform plan..."
              terraform plan -input=false -var-file=terraform.tfvars -out=tfplan.out

              echo "ğŸš€ Applying terraform plan..."
              terraform apply -input=false -auto-approve tfplan.out

              echo "âœ… Terraform apply completed."
            '''
          }
        }
      }
    }
  }
}
