pipeline {
  agent any

  parameters {
    string(name: 'env', description: 'Environment Name (e.g., dev, qa, prod)')
  }

  environment {
    TF_DIR = "environments/${params.env}"
  }

  stages {
    stage('Terraform Destroy') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-credentials', // your AWS creds id here
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          dir("${env.TF_DIR}") {
            sh '''
              set -e

              echo "ðŸ§ª Checking Terraform version..."
              terraform -version

              echo "ðŸ“¦ Running terraform init..."
              terraform init -input=false

              echo "ðŸ§¨ Destroying infrastructure for environment: ${params.env} ..."
              terraform destroy -auto-approve -var-file=terraform.tfvars

              echo "âœ… Terraform destroy completed."
            '''
          }
        }
      }
    }
  }
}
